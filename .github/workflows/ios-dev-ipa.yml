name: ios-dev-ipa

on:
  workflow_dispatch:

jobs:
  build-ios:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.3.5"

      - name: Install dependencies
        run: |
          rm -rf node_modules node_modules/.bun bun.lock
          rm -rf apps/mobile/node_modules apps/mobile/bun.lock
          bun install

      - name: Patch expo-modules-core Swift concurrency (SDK 54)
        run: |
          python - <<'PY'
          from pathlib import Path
          import glob
          import re

          # Find the expo-modules-core Swift file in .bun node_modules
          matches = glob.glob("node_modules/.bun/expo-modules-core@*/node_modules/expo-modules-core/ios/AppDelegates/ExpoAppDelegateSubscriberManager.swift")
          if not matches:
              print("No expo-modules-core Swift file found in expected paths")
              raise SystemExit(1)

          swift_file = Path(matches[0])
          text = swift_file.read_text()

          # Check if already patched by looking for both @MainActor and @preconcurrency before the class
          if re.search(r'@MainActor\s*@preconcurrency\s+(public\s+)?(final\s+)?class\s+ExpoAppDelegateSubscriberManager', text):
              print("File already has @MainActor and @preconcurrency annotations - skipping patch")
              raise SystemExit(0)

          # Pattern to match class declaration with optional modifiers and inheritance
          # Matches: class ExpoAppDelegateSubscriberManager: NSObject {
          # Matches: public class ExpoAppDelegateSubscriberManager: NSObject {
          # Matches: final class ExpoAppDelegateSubscriberManager: NSObject {
          # Matches: public final class ExpoAppDelegateSubscriberManager: NSObject {
          pattern = r'^(\s*)(public\s+)?(final\s+)?class\s+ExpoAppDelegateSubscriberManager\b[^{]*\{'

          def add_annotations(match):
              indent = match.group(1)
              public_mod = match.group(2) or ''
              final_mod = match.group(3) or ''
              return f"{indent}@MainActor\n{indent}@preconcurrency\n{indent}{public_mod}{final_mod}class ExpoAppDelegateSubscriberManager {{"

          new_text = re.sub(pattern, add_annotations, text, flags=re.MULTILINE)

          if new_text == text:
              print("WARNING: Pattern did not match - class declaration may have unexpected format")
              raise SystemExit(1)

          swift_file.write_text(new_text)
          print(f"SUCCESS: Patched {swift_file} with @MainActor and @preconcurrency annotations")
          PY

      - name: Prebuild iOS project
        working-directory: apps/mobile
        run: bunx expo prebuild --platform ios --clean

      - name: Patch Podfile for Swift concurrency
        working-directory: apps/mobile
        run: |
          python - <<'PY'
          from pathlib import Path

          podfile = Path("ios/Podfile")
          text = podfile.read_text()
          if "SWIFT_STRICT_CONCURRENCY" in text:
              raise SystemExit(0)

          marker = "post_install do |installer|"
          injection = "\n".join(
              [
                  "  installer.pods_project.targets.each do |target|",
                  "    target.build_configurations.each do |config|",
                  "      config.build_settings['SWIFT_VERSION'] = '5.9'",
                  "      config.build_settings['SWIFT_STRICT_CONCURRENCY'] = 'minimal'",
                  "      config.build_settings['SWIFT_TREAT_WARNINGS_AS_ERRORS'] = 'NO'",
                  "      config.build_settings['OTHER_SWIFT_FLAGS'] = '$(inherited) -Xfrontend -warn-concurrency'",
                  "    end",
                  "  end",
                  "  installer.aggregate_targets.each do |aggregate_target|",
                  "    aggregate_target.user_project.native_targets.each do |target|",
                  "      target.build_configurations.each do |config|",
                  "        config.build_settings['SWIFT_VERSION'] = '5.9'",
                  "        config.build_settings['SWIFT_STRICT_CONCURRENCY'] = 'minimal'",
                  "        config.build_settings['SWIFT_TREAT_WARNINGS_AS_ERRORS'] = 'NO'",
                  "        config.build_settings['OTHER_SWIFT_FLAGS'] = '$(inherited) -Xfrontend -warn-concurrency'",
                  "      end",
                  "    end",
                  "  end",
              ]
          )

          if marker in text:
              text = text.replace(marker, marker + "\n" + injection)
          else:
              text += "\n" + marker + "\n" + injection + "\nend\n"

          podfile.write_text(text)
          PY

      - name: Install CocoaPods
        run: sudo gem install cocoapods

      - name: Install iOS pods
        working-directory: apps/mobile
        run: pod install --project-directory=ios

      - name: Build unsigned app
|      xcodebuild \
        working-directory: apps/mobile
        run: |
          xcodebuild -list -workspace ios/Quickstart.xcworkspace
          xcodebuild \
            -workspace ios/Quickstart.xcworkspace \
            -scheme Quickstart \
            -configuration Release \
            -sdk iphoneos \
            -destination "generic/platform=iOS" \
            -derivedDataPath build/DerivedData \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGN_IDENTITY="" \
            clean build

      - name: Package unsigned IPA
        working-directory: apps/mobile
        run: |
          APP_PATH=$(find build/DerivedData/Build/Products -name "*.app" -maxdepth 3 | head -n 1)
          if [ -z "$APP_PATH" ]; then
            echo "No .app found in DerivedData"
            exit 1
          fi
          mkdir -p build/Payload
          cp -R "$APP_PATH" build/Payload/
          cd build
          zip -r quickstart-unsigned.ipa Payload

      - name: Upload IPA
        uses: actions/upload-artifact@v4
        with:
          name: quickstart-unsigned-ipa
          path: apps/mobile/build/quickstart-unsigned.ipa
